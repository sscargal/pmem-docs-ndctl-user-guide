# ndctl−load−keys\(1\)

[NAME](ndctl-load-keys.md#name)  
[SYNOPSIS](ndctl-load-keys.md#synopsis)  
[DESCRIPTION](ndctl-load-keys.md#description)  
[OPTIONS](ndctl-load-keys.md#options)  
[THEORY OF OPERATION](ndctl-load-keys.md#theory-of-operation)  
[COPYRIGHT](ndctl-load-keys.md#copyright)

## NAME

ndctl−load−keys − load the kek and encrypted passphrases into the keyring

## SYNOPSIS

_ndctl load−keys_ \[&lt;options&gt;\]

## DESCRIPTION

The _load−keys_ command loads the master key \(_kek_\) and the encrypted passphrases for all NVDIMMs into the user keyring maintained by the kernel. The command is expected to be called during initialization and before the libnvdimm kernel module is loaded, typically from an initrd. This is typically set up using a modprobe config that calls the command before module load.

**Note**  
All key files are expected to be in the format: nvdimm_\_hostname  
The '_' character is used to delimit the different components in the file name. Within the hostname, the '\_' character is allowed since it is the last component of the file name.

**Note**  
This command is typically never called directly by a user.

## OPTIONS

−p, −−key−path=

Path to where key related files reside. This parameter is optional and the default location is /etc/ndctl/keys.

−t, −−tpm−handle=

Provide a TPM handle \(should be a string such as 0x81000001\). If the key path \(/etc/ndctl/keys\) contains a file called tpm.handle which contains the handle string, then this option may be left out, and the tpm handle will be obtained from the file. If both are present, then this option will override \(but not overwrite\) anything that is in the file.

## THEORY OF OPERATION

The Intel Device Specific Methods \(DSM\) specification v1.7 and v1.8 \[1\] introduced the following security management operations: enable passhprase, update passphrase, unlock DIMM, disable security, freeze security, secure \(crypto\) erase, overwrite, master passphrase enable, master passphrase update, and master passphrase secure erase.

The security management for NVDIMMs is comprised of two parts. The front end uses the Linux key management framework \(trusted and encrypted keys \[2\]\) to store the encrypted passphrases in the kernel−managed keyring. The interface for this is the _keyutils_ utility which uses the key management APIs in the Linux kernel. The back end takes the decrypted payload \(which is the DIMM passphrase\) and passes it to the DIMM.

Unlike other DSMs which are composed by libndctl and sent to the kernel via an ioctl, the security DSMs are managed through the _security_ sysfs attribute under the _dimm_ device. A _key−ID_ is written to the _security_ attribute and the kernel pulls the associated key material from the user keyring that is maintained by the kernel.

The security process begins with the generation of a _master key_ that is used to seal \(encrypt\) the passphrase for the DIMM. There can either be one common _master key_ that is used to encrypt every DIMM’s passphrase, or a separate key can be generated for each DIMM. The _master key_ is also referred to as the _key−encryption−key_ \(kek\). The _kek_ can either be generated by the TPM \(Trusted Platform Module\) on the system, or alternatively, the _System Master Key_ can also be used as the _kek_

For testing purposes a user key with randomized payload can also be used as a _kek_. See \[2\] for details. To perform any security operations, it is expected that the _kek_ has been added to the kernel’s user keyring as shown in example below:

```text
# keyctl show
Session Keyring
736023423 --alswrv      0     0  keyring: _ses
675104189 --alswrv      0 65534   \_ keyring: _uid.0
680187394 --alswrv      0     0       \_ trusted: nvdimm-master
```

Before performing any of the security operations, all the regions associated with the DIMM in question need to be disabled. For the _overwrite_ operation, in addition to the _regions_, the _dimm_ also needs to be disabled.

\[1\] [http://pmem.io/documents/NVDIMM\_DSM\_Interface−V1.8.pdf](http://pmem.io/documents/NVDIMM_DSM_Interface−V1.8.pdf)  
\[2\] [https://www.kernel.org/doc/Documentation/security/keys/trusted−encrypted.rst](https://www.kernel.org/doc/Documentation/security/keys/trusted−encrypted.rst)

The following sub−sections describe specifics of each security feature.

### **UNLOCK**

Unlock is performed by the kernel, however a preparation step must happen before the unlock DSM can be issued by the kernel. It is expected that from the initramfs, a setup command \(ndctl _load−keys_\) is executed before the libnvdimm module is loaded by modprobe. This command will inject the _kek_ and the encrypted passphrases into the kernel’s user keyring. During the _probe_ of the libnvdimm driver, it will:

1. Check the security state of the device and see if the DIMM is locked

2. Request the associated encrypted passphrase from the kernel’s user key ring

3. Use the _kek_ to decrypt the passphrase

4. Create the unlock DSM, copy the decrypted payload into the DSM

5. Issue the DSM to unlock the DIMM

If the DIMM is already unlocked, the kernel will attempt to revalidate the passphrase. If we fail to revalidate the passphrase, the kernel will freeze the security and disallow any further security configuration changes. A kernel module parameter is available to override this behavior.

### **SETUP USER PASSPHRASE**

To setup the passphrase for a DIMM, it is expected that the _kek_ to be used is present in the kernel’s user keyring. The _kek_ encrypts the DIMM passphrase using the _enc32_ key format. The plaintext passphrase is never provided by or made visible to the user. It is instead randomly generated by the kernel and userspace does not have access to it. Upon encryption, a binary blob of the passphrase is written to the passphrase blob storage directory \(/etc/ndctl/keys\). The user is responsible for backing up the passphrase blobs to a secure location.

### **UPDATE USER PASSPHRASE**

The update user passphrase operation uses the same DSM command as enable user passphrase. Most of the work is done on the key management side. The user has the option of providing a new _kek_ for the new passphrase, but continuing to use the existing _kek_ is also acceptable. The following operations are performed for _update−passphrase_:

1. Remove the encrypted passphrase from the kernel’s user keyring.

2. Rename the passphrase blob to old.

3. Load this old passphrase blob into the keyring with an "old" name.

4. Create the new passphrase and encrypt with the _kek_.

5. Send DSM with the old and new decrypted passphrases.

6. Remove old passphrase and the passphrase blob from the keyring.

### **REMOVE USER PASSPHRASE**

The _key−ID_ for the passphrase to be removed is written to sysfs. The kernel then sends the DSM to disable security, and the passphrase is then removed from the keyring, and the associated passphrase blob is deleted.

### **CRYPTO \(SECURE\) ERASE**

This operation is similar to remove−passphrase. The kernel issues a WBINVD instruction before and after the operation to ensure no data corruption from a stale CPU cache. Use ndctl’s sanitize−dimm command with the −−crypto−erase option to perform this operation.

### **OVERWRITE**

This is invoked using −−overwrite option for ndctl _sanitize−dimm_. The overwrite operation wipes the entire NVDIMM. The operation can take a significant amount of time. NOTE: When the command returns successfully, it just means overwrite has been successfully started, and not that the overwrite is complete. Subsequently, 'ndctl wait−overwrite’can be used to wait for the NVDIMMs that are performing overwrite. Upon successful completion of an overwrite, the WBINVD instruction is issued by the kernel. If both −−crypto−erase and −−overwrite options are supplied, then crypto−erase is performed before overwrite.

### **SECURITY FREEZE**

This operation does not require a passphrase. This will cause any security command other than a status query to be locked out until the next boot.

### **MASTER PASSPHRASE SETUP, UPDATE, and CRYPTO ERASE**

These operations are similar to the user passphrase enable and update. The only difference is that a different passphrase is used. The master passphrase has no relation to the master key \(_kek_\) which is used for encryption of either passphrase.

## COPYRIGHT

Copyright \(c\) 2016 − 2019, Intel Corporation. License GPLv2: GNU GPL version 2 [http://gnu.org/licenses/gpl.html](http://gnu.org/licenses/gpl.html). This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law.

